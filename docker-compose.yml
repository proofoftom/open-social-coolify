services:
  opensocial:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Database connection
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-opensocial}
      DB_USER: ${DB_USER:-opensocial}
      DB_PASSWORD: ${DB_PASSWORD:-changeme_in_production}
      # Drupal settings
      DRUPAL_HASH_SALT: ${DRUPAL_HASH_SALT:-generate-a-random-string-here}
      DRUPAL_TRUSTED_HOST_PATTERNS: ${DRUPAL_TRUSTED_HOST_PATTERNS:-}
      DRUPAL_REVERSE_PROXY: "true"
      # Solr settings
      SOLR_HOST: solr
      SOLR_PORT: 8983
      SOLR_PATH: /solr
      # Auto-install settings
      DRUPAL_SITE_NAME: ${DRUPAL_SITE_NAME:-Open Social}
      DRUPAL_ADMIN_USER: ${DRUPAL_ADMIN_USER:-admin}
      DRUPAL_ADMIN_PASS: ${DRUPAL_ADMIN_PASS:-admin}
      DRUPAL_ADMIN_EMAIL: ${DRUPAL_ADMIN_EMAIL:-admin@example.com}
      # Coolify-provided variables (auto-detected for trusted hosts)
      SERVICE_FQDN_OPENSOCIAL: ${SERVICE_FQDN_OPENSOCIAL:-}
      SERVICE_URL_OPENSOCIAL: ${SERVICE_URL_OPENSOCIAL:-}
      COOLIFY_FQDN: ${COOLIFY_FQDN:-}
      COOLIFY_URL: ${COOLIFY_URL:-}
    volumes:
      - opensocial_files:/var/www/html/html/sites/default/files
      - opensocial_private:/var/www/private
    depends_on:
      mariadb:
        condition: service_healthy
      solr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/core/install.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "coolify.managed=true"

  mariadb:
    image: mariadb:10.11
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_NAME:-opensocial}
      MYSQL_USER: ${DB_USER:-opensocial}
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme_in_production}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${DB_USER:-opensocial}", "-p${DB_PASSWORD:-changeme_in_production}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  solr:
    image: solr:8.11
    restart: unless-stopped
    ports:
      - "8983:8983"
    volumes:
      - solr_data:/var/solr
      - ./solr-config:/opt/solr/server/solr/configsets/opensearch/conf
    environment:
      - SOLR_HEAP=512m
    command: >
      bash -c "
        # Wait a moment for file system to be ready
        sleep 2 &&
        # Copy configset to a working directory where we have permissions
        cp -r /opt/solr/server/solr/configsets/_default/conf/* /opt/solr/server/solr/configsets/opensearch/conf/ &&
        # Then ensure our core.properties is in place
        echo 'name=drupal' > /opt/solr/server/solr/configsets/opensearch/conf/core.properties &&
        # Create the core
        solr-precreate drupal /opt/solr/server/solr/configsets/opensearch &&
        exec solr -f
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  opensocial_files:
  opensocial_private:
  mariadb_data:
  solr_data:
