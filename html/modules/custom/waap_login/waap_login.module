<?php

/**
 * @file
 * Contains hook implementations for WaaP Login module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\user\UserInterface;

/**
 * Implements hook_help().
 */
function waap_login_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.waap_login':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The WaaP Login module provides Wallet as a Protocol authentication for Drupal using Human.tech WaaP SDK.') . '</p>';
      $output .= '<h3>' . t('Features') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Multi-method authentication: email, phone, social (Google, Twitter, Discord, etc.), and traditional wallet connections') . '</li>';
      $output .= '<li>' . t('EIP-1193 compatible Ethereum provider interface') . '</li>';
      $output .= '<li>' . t('Managed security with 2PC/MPC security model') . '</li>';
      $output .= '<li>' . t('Optional Gas Tank support for sponsored transactions') . '</li>';
      $output .= '<li>' . t('Cross-dApp compatibility') . '</li>';
      $output .= '</ul>';
      $output .= '<h3>' . t('Configuration') . '</h3>';
      $output .= '<p>' . t('Configure the module at <a href=":url">WaaP Login settings</a>.', [':url' => \Drupal::url('waap_login.settings')]) . '</p>';
      $output .= '<h3>' . t('Integration') . '</h3>';
      $output .= '<p>' . t('The module integrates with the existing field_ethereum_address field, allowing coexistence with SIWE Login authentication.') . '</p>';
      return $output;

    case 'waap_login.settings':
      $output = '<p>' . t('Configure WaaP Login authentication settings including authentication methods, allowed social providers, and user management options.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function waap_login_theme($existing, $type, $theme, $path) {
  return [
    'waap_login_button' => [
      'variables' => [],
    ],
    'waap_logout_button' => [
      'variables' => ['user' => NULL],
    ],
    // Email verification templates
    'waap_email_verification_html' => [
      'variables' => [
        'verification_url' => '',
        'user_name' => '',
        'wallet_address' => '',
        'site_name' => '',
        'expiration_hours' => 24,
      ],
    ],
    'waap_email_verification_text' => [
      'variables' => [
        'verification_url' => '',
        'user_name' => '',
        'wallet_address' => '',
        'site_name' => '',
        'expiration_hours' => 24,
      ],
    ],
    // Welcome email templates
    'waap_welcome_html' => [
      'variables' => [
        'user_name' => '',
        'wallet_address' => '',
        'site_name' => '',
        'login_url' => '',
        'profile_url' => '',
      ],
    ],
    'waap_welcome_text' => [
      'variables' => [
        'user_name' => '',
        'wallet_address' => '',
        'site_name' => '',
        'login_url' => '',
        'profile_url' => '',
      ],
    ],
  ];
}

/**
 * Implements hook_user_login().
 *
 * Handles WaaP authentication events including logging, session management,
 * and sending welcome emails to first-time users.
 */
function waap_login_user_login(UserInterface $account) {
  try {
    // Check if this is a WaaP login by checking session data
    $session_validator = \Drupal::service('waap_login.session_validator');
    $session = $session_validator->getSession($account->id());

    if ($session) {
      // Log WaaP login event
      \Drupal::logger('waap_login')->info('User @username logged in via WaaP with address @address', [
        '@username' => $account->getAccountName(),
        '@address' => $session['address'] ?? 'unknown',
      ]);

      // Check if this is the first-time WaaP login
      $is_first_login = !$account->getLastLoginTime();

      if ($is_first_login) {
        // Send welcome email for first-time WaaP users
        $mail_manager = \Drupal::service('plugin.manager.mail');
        $params = [
          'user' => $account,
          'wallet_address' => $session['address'] ?? '',
        ];

        $mail_manager->mail(
          'waap_login',
          'welcome',
          $account->getEmail(),
          $account->getPreferredLangcode(),
          $params,
          NULL,
          TRUE
        );

        \Drupal::logger('waap_login')->notice('Welcome email sent to first-time WaaP user @uid', [
          '@uid' => $account->id(),
        ]);
      }

      // Update user's last login metadata with WaaP-specific info
      // Store additional metadata in key-value store
      \Drupal::keyValue('waap_login.user_data')->set($account->id(), [
        'last_waap_login' => time(),
        'last_login_type' => $session['login_type'] ?? 'unknown',
        'last_login_method' => $session['login_method'] ?? 'unknown',
        'last_provider' => $session['provider'] ?? '',
      ]);
    }
  }
  catch (\Exception $e) {
    // Log error but don't prevent login
    \Drupal::logger('waap_login')->error('Error in hook_user_login: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_user_logout().
 *
 * Cleans up WaaP session data and logs logout events.
 */
function waap_login_user_logout($account) {
  try {
    // Clear WaaP session data from key-value store
    $session_validator = \Drupal::service('waap_login.session_validator');
    $session_validator->clearSession($account->id());

    // Clear private temp store for the user
    $temp_store = \Drupal::service('user.private_tempstore')->get('waap_login');
    try {
      $temp_store->delete('pending_verification');
      $temp_store->delete('pending_username');
    }
    catch (\Exception $e) {
      // Temp store errors are not critical
    }

    // Clear user-specific key-value data
    \Drupal::keyValue('waap_login.user_data')->delete($account->id());

    // Log logout event
    \Drupal::logger('waap_login')->info('User @uid logged out from WaaP', [
      '@uid' => $account->id(),
    ]);
  }
  catch (\Exception $e) {
    // Log error but don't prevent logout
    \Drupal::logger('waap_login')->error('Error in hook_user_logout: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Attaches WaaP SDK library and passes configuration to JavaScript
 * on relevant pages only.
 */
function waap_login_page_attachments(array &$attachments) {
  $config = \Drupal::config('waap_login.settings');

  // Only attach if module is enabled
  if (!$config->get('enabled')) {
    return;
  }

  // Attach WaaP SDK library
  $attachments['#attached']['library'][] = 'waap_login/sdk';

  // Pass settings to JavaScript
  $attachments['#attached']['drupalSettings']['waap_login'] = [
    'enabled' => TRUE,
    'use_staging' => $config->get('use_staging'),
    'authentication_methods' => $config->get('authentication_methods') ?? ['email', 'social', 'wallet'],
    'allowed_socials' => $config->get('allowed_socials') ?? ['google', 'twitter', 'discord'],
    'walletconnect_project_id' => $config->get('walletconnect_project_id'),
    'enable_dark_mode' => $config->get('enable_dark_mode'),
    'show_secured_badge' => $config->get('show_secured_badge'),
    'referral_code' => $config->get('referral_code'),
    'gas_tank_enabled' => $config->get('gas_tank_enabled'),
    'csrf_token' => \Drupal::csrfToken()->get('waap_login'),
  ];
}

/**
 * Implements hook_mail().
 *
 * Handles email verification and welcome email rendering.
 */
function waap_login_mail($key, &$message, $params) {
  $renderer = \Drupal::service('renderer');
  $site_config = \Drupal::config('system.site');
  $site_name = $site_config->get('name');

  switch ($key) {
    case 'email_verification':
      // Set email verification email subject
      $message['subject'] = t('Verify your email address for @site', ['@site' => $site_name]);

      // Render HTML version
      $html_template = [
        '#theme' => 'waap_email_verification_html',
        '#verification_url' => $params['verification_url'],
        '#user_name' => $params['user_name'],
        '#wallet_address' => $params['wallet_address'],
        '#site_name' => $site_name,
        '#expiration_hours' => $params['expiration_hours'] ?? 24,
      ];
      $message['body'][] = $renderer->renderPlain($html_template);

      // Set HTML content type
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
      break;

    case 'welcome':
      // Set welcome email subject
      $message['subject'] = t('Welcome to @site!', ['@site' => $site_name]);

      // Render HTML version
      $html_template = [
        '#theme' => 'waap_welcome_html',
        '#user_name' => $params['user']->getAccountName(),
        '#wallet_address' => $params['wallet_address'],
        '#site_name' => $site_name,
        '#login_url' => \Drupal\Core\Url::fromRoute('user.login')->setAbsolute()->toString(),
        '#profile_url' => \Drupal\Core\Url::fromRoute('entity.user.canonical', ['user' => $params['user']->id()])->setAbsolute()->toString(),
      ];
      $message['body'][] = $renderer->renderPlain($html_template);

      // Set HTML content type
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
      break;
  }
}

/**
 * Implements hook_user_presave().
 *
 * Validates wallet address before saving and prevents duplicate addresses.
 */
function waap_login_user_presave(UserInterface $user) {
  try {
    // Check if wallet address field is being modified
    if ($user->hasField('field_ethereum_address')) {
      $new_address = $user->get('field_ethereum_address')->value;

      // Only validate if address is set and has changed
      if (!empty($new_address)) {
        $auth_service = \Drupal::service('waap_login.auth_service');

        // Validate address format
        if (!$auth_service->validateAddress($new_address)) {
          throw new \Drupal\waap_login\Exception\WaapInvalidAddressException(
            t('Invalid Ethereum wallet address format.')
          );
        }

        // Check for duplicate wallet addresses (excluding current user)
        if (!$user->isNew()) {
          $user_manager = \Drupal::service('waap_login.user_manager');
          $existing_user = $user_manager->findUserByAddress($new_address);

          if ($existing_user && $existing_user->id() !== $user->id()) {
            throw new \Drupal\waap_login\Exception\WaapUserCreationException(
              t('This wallet address is already linked to another account.')
            );
          }

          // Log wallet address changes
          $original_address = $user->original->get('field_ethereum_address')->value;
          if ($original_address !== $new_address) {
            \Drupal::logger('waap_login')->notice('User @uid changed wallet address from @old to @new', [
              '@uid' => $user->id(),
              '@old' => $original_address ?? 'none',
              '@new' => $new_address,
            ]);
          }
        }
      }
    }
  }
  catch (\Drupal\waap_login\Exception\WaapInvalidAddressException $e) {
    // Re-throw validation exceptions
    throw $e;
  }
  catch (\Drupal\waap_login\Exception\WaapUserCreationException $e) {
    // Re-throw user creation exceptions
    throw $e;
  }
  catch (\Exception $e) {
    // Log other errors but don't prevent save
    \Drupal::logger('waap_login')->error('Error in hook_user_presave: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_user_delete().
 *
 * Cleans up WaaP-related data when a user account is deleted.
 */
function waap_login_user_delete(UserInterface $account) {
  try {
    // Clear WaaP session data
    $session_validator = \Drupal::service('waap_login.session_validator');
    $session_validator->clearSession($account->id());

    // Clear user-specific key-value data
    \Drupal::keyValue('waap_login.user_data')->delete($account->id());

    // Clear private temp store for the user
    $temp_store = \Drupal::service('user.private_tempstore')->get('waap_login');
    try {
      $temp_store->delete('pending_verification');
      $temp_store->delete('pending_username');
    }
    catch (\Exception $e) {
      // Temp store errors are not critical
    }

    // Log account deletion
    \Drupal::logger('waap_login')->notice('WaaP data cleaned up for deleted user @uid', [
      '@uid' => $account->id(),
    ]);
  }
  catch (\Exception $e) {
    // Log error but don't prevent deletion
    \Drupal::logger('waap_login')->error('Error in hook_user_delete: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_cron().
 *
 * Cleans up expired verification tokens, old session data,
 * and temp store entries older than 48 hours.
 */
function waap_login_cron() {
  try {
    $logger = \Drupal::logger('waap_login');

    // Clean up expired verification tokens (older than 24 hours)
    $key_value = \Drupal::keyValue('waap_login.verification_tokens');
    $expiration_time = time() - (24 * 60 * 60); // 24 hours ago
    $tokens_cleaned = 0;

    // Get all tokens and check expiration
    $all_tokens = $key_value->getAll();
    foreach ($all_tokens as $key => $data) {
      if (isset($data['created']) && $data['created'] < $expiration_time) {
        $key_value->delete($key);
        $tokens_cleaned++;
      }
    }

    if ($tokens_cleaned > 0) {
      $logger->info('Cleaned up @count expired verification tokens', ['@count' => $tokens_cleaned]);
    }

    // Clean up old session data (older than 48 hours)
    $session_store = \Drupal::keyValue('waap_login.sessions');
    $session_expiration = time() - (48 * 60 * 60); // 48 hours ago
    $sessions_cleaned = 0;

    $all_sessions = $session_store->getAll();
    foreach ($all_sessions as $uid => $session_data) {
      if (isset($session_data['timestamp']) && $session_data['timestamp'] < $session_expiration) {
        $session_store->delete($uid);
        $sessions_cleaned++;
      }
    }

    if ($sessions_cleaned > 0) {
      $logger->info('Cleaned up @count expired WaaP sessions', ['@count' => $sessions_cleaned]);
    }

    // Clean up old temp store entries (older than 48 hours)
    $temp_store = \Drupal::service('user.shared_tempstore')->get('waap_login');
    $temp_expiration = time() - (48 * 60 * 60); // 48 hours ago
    $temp_cleaned = 0;

    // Note: TempStore doesn't have a getAll method, so we clean by known keys
    // This is a simplified approach - in production, you might want to track keys
    $known_temp_keys = ['pending_verification', 'pending_username'];
    foreach ($known_temp_keys as $key) {
      try {
        $data = $temp_store->get($key);
        if (is_array($data) && isset($data['created']) && $data['created'] < $temp_expiration) {
          $temp_store->delete($key);
          $temp_cleaned++;
        }
      }
      catch (\Exception $e) {
        // Continue on error
      }
    }

    if ($temp_cleaned > 0) {
      $logger->info('Cleaned up @count expired temp store entries', ['@count' => $temp_cleaned]);
    }

  }
  catch (\Exception $e) {
    \Drupal::logger('waap_login')->error('Error in hook_cron: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Allow other modules to alter WaaP login response.
 *
 * This hook is invoked after a successful WaaP authentication,
 * allowing other modules to modify the response or add redirects.
 *
 * @param array $response
 *   The response array to be returned to the client.
 * @param \Drupal\user\UserInterface|null $user
 *   The authenticated user, or NULL if authentication failed.
 * @param array $context
 *   Additional context data including:
 *   - 'address': The wallet address used for authentication
 *   - 'login_type': The type of login (waap, injected, walletconnect)
 *   - 'session_data': The WaaP session data
 *
 * @see \Drupal\waap_login\Service\WaapAuthService::authenticate()
 *
 * @ingroup hooks
 */
function hook_waap_login_response_alter(array &$response, ?UserInterface $user, array $context) {
  // Example: Add Safe Smart Accounts redirect for new users
  // if ($user && \Drupal::moduleHandler()->moduleExists('safe_smart_accounts')) {
  //   $user_manager = \Drupal::service('waap_login.user_manager');
  //   if ($user_manager->isGeneratedUsername($user->getAccountName(), $context['address'])) {
  //     $response['redirect'] = '/user/' . $user->id() . '/safe-accounts/setup';
  //   }
  // }

  // Example: Add custom metadata to response
  // if ($user) {
  //   $response['user']['custom_field'] = $user->get('some_custom_field')->value;
  // }

  // Example: Log authentication for analytics
  // \Drupal::logger('custom_analytics')->info('WaaP login: @type for user @uid', [
  //   '@type' => $context['login_type'],
  //   '@uid' => $user ? $user->id() : 'none',
  // ]);
}
